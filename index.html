<!doctype html>
<html lang="is">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SendGrid tools</title>

  <!-- html2canvas for PNG export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    /* Load Basic Sans from /fonts */
    @font-face {
      font-family: "Basic Sans";
      src: url("./fonts/basicsans-regular.woff") format("woff");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    /* UI uses system font */
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 24px;
      color: #111;
    }

    h1 { font-size: 20px; margin: 0 0 6px; }
    .muted { color:#666; font-size: 12px; margin: 0 0 14px; }

    /* Tabs */
    .tabs { display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap; }
    .tab-btn {
      cursor:pointer; padding:8px 12px; border-radius:10px; border:1px solid #111;
      background:#fff; color:#111; font-weight:700; font-size:13px;
    }
    .tab-btn.active { background:#111; color:#fff; }
    .tab { display:none; }
    .tab.active { display:block; }

    /* Shared layout */
    .wrap { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; align-items: start; }
    .panel { border: 1px solid #ddd; border-radius: 10px; padding: 14px; }
    .panel h2 { font-size: 16px; margin: 0 0 10px; }
    label { font-size: 12px; font-weight: 600; display:block; margin-top: 10px; }
    input { width:100%; padding:8px; border:1px solid #ccc; border-radius:8px; font-size:14px; }
    textarea {
      width:100%; min-height: 280px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px; padding:10px; border:1px solid #ccc; border-radius:8px;
      white-space: pre; overflow:auto;
    }
    .preview { background:#fafafa; padding: 10px; border-radius: 8px; border:1px dashed #ccc; overflow:auto; }
    .btns { display:flex; gap:10px; margin-top: 12px; flex-wrap: wrap; }
    button {
      cursor:pointer; padding:8px 12px; border-radius:8px; border:1px solid #111;
      background:#111; color:#fff; font-weight:700;
    }
    button.ghost { background:#fff; color:#111; }
    .note { font-size:12px; color:#444; margin-top:8px; }

    /* 3-column input */
    .row3 { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; }

    /* UTM controls */
    .toggle-row { display:flex; align-items:center; gap:8px; margin-top: 6px; }
    .toggle-row input[type="checkbox"] { width:auto; transform: translateY(1px); }
    .utm-grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-top: 8px; }
    .utm-grid input { font-size:13px; }
    .small { font-size:12px; color:#555; margin-top:6px; }

    /* Fixed-size product card preview frame (optional; card HTML is self-contained) */
    .card-shell {
      margin-top:14px;
      width:420px;
      height:479px;
      border:1px solid #D9D9D9;
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 1px 6px rgba(0,0,0,0.06);
      background:#fff;
      box-sizing:border-box;
      font-family:"Basic Sans", Arial, sans-serif;
    }
  </style>
</head>

<body>
  <h1>SendGrid marketing tools</h1>
  <p class="muted">Two-tools: 3 column block for code view + “Create card” from product url.</p>

  <div class="tabs">
    <button class="tab-btn active" data-tab="tab-3col">3-column block</button>
    <button class="tab-btn" data-tab="tab-card">Create card from url</button>
    <button class="tab-btn" data-tab="tab-2recipes">2-column recipes</button>
  </div>

  <!-- ===================== TAB 1: 3-column generator ===================== -->
  <section id="tab-3col" class="tab active">
    <div class="wrap">
      <div class="panel">
        <h2>3-column block</h2>

        <!-- UTM controls -->
        <div class="toggle-row">
          <input id="utmToggle3" type="checkbox" checked />
          <label for="utmToggle3" style="margin:0;">Bæta UTM á vörutengla</label>
        </div>
        <div class="utm-grid" id="utmFields3">
          <div>
            <label style="margin-top:8px;">utm_source</label>
            <input id="utmSource3" value="sendgrid" />
          </div>
          <div>
            <label style="margin-top:8px;">utm_medium</label>
            <input id="utmMedium3" value="email" />
          </div>
          <div>
            <label style="margin-top:8px;">utm_campaign</label>
            <input id="utmCampaign3" value="marketing_single_send" />
          </div>
        </div>
        <div class="small">Ef slökkt er á þessu, fara tenglar inn óbreyttir.</div>

        <div class="row3" id="inputs3col" style="margin-top:12px;"></div>

        <div class="btns">
          <button id="resetBtn3col" class="ghost" type="button">Hreinsa</button>
          <button id="copyBtn3col" type="button">Afrita HTML</button>
        </div>
        <div id="copyStatus3col" class="note"></div>
      </div>

      <div class="panel">
        <h2>Forskoðun</h2>
        <div class="preview" id="preview3col"></div>

        <h2 style="margin-top:14px;">Úttak (copy/paste í SendGrid)</h2>
        <textarea id="output3col" readonly></textarea>
      </div>
    </div>
  </section>

<!-- ===================== TAB: 2-column recipes ===================== -->
<section id="tab-2recipes" class="tab">
  <div class="wrap">
    <div class="panel">
      <h2>2-column recipes</h2>

      <div class="row3" id="inputs2recipes" style="margin-top:12px; grid-template-columns: repeat(2,1fr);"></div>

      <div class="btns">
        <button id="resetBtn2recipes" class="ghost" type="button">Hreinsa</button>
        <button id="copyBtn2recipes" type="button">Afrita HTML</button>
      </div>
      <div id="copyStatus2recipes" class="note"></div>
    </div>

    <div class="panel">
      <h2>Forskoðun</h2>
      <div class="preview" id="preview2recipes"></div>

      <h2 style="margin-top:14px;">Úttak (copy/paste í SendGrid)</h2>
      <textarea id="output2recipes" readonly></textarea>
    </div>
  </div>
</section>

  
  <!-- ===================== TAB 2: Product card builder ===================== -->
  <section id="tab-card" class="tab">
    <div class="wrap">
      <div class="panel">
        <h2>Create card from url</h2>

        <label>Product URL (kronan.is/vara/...)</label>
        <input id="productUrlCard" placeholder="https://kronan.is/vara/100258554" />

        <!-- NEW: optional overrides -->
        <label>Product name (optional edit)</label>
        <input id="manualName" placeholder="(auto-filled after Create card)" />

        <label>Price (optional edit)</label>
        <input id="manualPrice" placeholder="e.g. 489 kr." />

        <div class="btns">
          <button id="createBtnCard" type="button">Create card</button>
          <button id="updateBtnCard" class="ghost" type="button">Update card</button>
          <button id="copyBtnCard" class="ghost" type="button">Copy HTML</button>
          <button id="downloadPngBtnCard" class="ghost" type="button">Download PNG</button>
        </div>

        <div id="statusCard" class="note"></div>
      </div>

      <div class="panel">
        <h2>Forskoðun</h2>
        <div id="previewCard"></div>

        <h2 style="margin-top:14px;">Úttak (copy/paste)</h2>
        <textarea id="outputCard" readonly></textarea>
      </div>
    </div>
  </section>

<script>
/* ===================== Tabs ===================== */
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

/* ===================== TAB 1: 3-column generator ===================== */
const NUM_COLUMNS = 3;

const products3col = Array.from({ length: NUM_COLUMNS }, () => ({
  href: "",
  src: "",
  alt: ""
}));

const inputs3colEl = document.getElementById("inputs3col");
const output3colEl = document.getElementById("output3col");
const preview3colEl = document.getElementById("preview3col");
const copyBtn3col = document.getElementById("copyBtn3col");
const resetBtn3col = document.getElementById("resetBtn3col");
const copyStatus3col = document.getElementById("copyStatus3col");

const utmToggle3 = document.getElementById("utmToggle3");
const utmSource3 = document.getElementById("utmSource3");
const utmMedium3 = document.getElementById("utmMedium3");
const utmCampaign3 = document.getElementById("utmCampaign3");
const utmFields3 = document.getElementById("utmFields3");

function renderInputs3col() {
  inputs3colEl.innerHTML = "";
  products3col.forEach((p, idx) => {
    const card = document.createElement("div");
    card.innerHTML = `
      <div style="border:1px solid #eee;border-radius:10px;padding:10px;">
        <strong>Dálkur ${idx+1}</strong>

        <label>Vörutengill (href)</label>
        <input data-k="href" data-i="${idx}" placeholder="https://kronan.is/vara/..." value="${p.href}"/>

        <label>Myndatengill (src)</label>
        <input data-k="src" data-i="${idx}" placeholder="http://cdn.mcauto-images...png" value="${p.src}"/>

        <label>Alt text (valfrjálst)</label>
        <input data-k="alt" data-i="${idx}" placeholder="t.d. Maiskökur" value="${p.alt}"/>
      </div>
    `;
    inputs3colEl.appendChild(card);
  });

  inputs3colEl.querySelectorAll("input").forEach(inp => {
    inp.addEventListener("input", e => {
      const i = Number(e.target.dataset.i);
      const k = e.target.dataset.k;
      products3col[i][k] = e.target.value.trim();
      update3col();
    });
  });
}

const TEMPLATE_3COL = String.raw`<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
  /* Mobile-only overrides (Gmail/Android friendly) */
  @media only screen and (max-width:640px),
         only screen and (max-device-width:640px) {

    .responsive-table, [class~="responsive-table"] {
      width: 100% !important;
      margin: 0 auto !important;
      padding: 0 !important; /* avoid double padding from wrapper */
    }

    .column, [class~="column"] {
      display: block !important;
      width: 100% !important;
      max-width: 100% !important;
      text-align: center !important;
      margin: 0 auto 20px !important;
      padding: 0 !important; /* prevent compounding widths */
    }

    /* Reliable 28px side gutters per card */
    .mobile-pad, [class~="mobile-pad"] {
      padding-left: 28px !important;
      padding-right: 28px !important;
    }

    .column img, [class~="column"] img {
      width: 100% !important;
      height: auto !important;
      max-width: 100% !important;
      display: block !important;
      margin: 0 auto !important;
    }
  }
  </style>
</head>

<body>
  <table class="responsive-table" width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;">
    <tr>
      <!-- First Column -->
      <td class="column" width="33.33%" valign="top" style="padding:10px; font-size:14px; line-height:20px;">
        <table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0">
          <tr>
            <!-- Mobile adds 28px L/R here -->
            <td class="mobile-pad" style="padding:0;">
              <a href="{{href1}}">
                <img border="0" style="display:block; max-width:100%; width:100%; height:auto;" width="186" alt="{{alt1}}" src="{{src1}}">
              </a>
            </td>
          </tr>
        </table>
      </td>

      <!-- Second Column -->
      <td class="column" width="33.33%" valign="top" style="padding:10px; font-size:14px; line-height:20px;">
        <table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0">
          <tr>
            <td class="mobile-pad" style="padding:0;">
              <a href="{{href2}}">
                <img border="0" style="display:block; max-width:100%; width:100%; height:auto;" width="186" alt="{{alt2}}" src="{{src2}}">
              </a>
            </td>
          </tr>
        </table>
      </td>

      <!-- Third Column -->
      <td class="column" width="33.33%" valign="top" style="padding:10px; font-size:14px; line-height:20px;">
        <table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0">
          <tr>
            <td class="mobile-pad" style="padding:0;">
              <a href="{{href3}}">
                <img border="0" style="display:block; max-width:100%; width:100%; height:auto;" width="186" alt="{{alt3}}" src="{{src3}}">
              </a>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>`;

function buildHtml3col() {
  let html = TEMPLATE_3COL;

  products3col.forEach((p, idx) => {
    const n = idx + 1;

    const finalHref = utmToggle3.checked
      ? addUTM(p.href, {
          utm_source: utmSource3.value.trim(),
          utm_medium: utmMedium3.value.trim(),
          utm_campaign: utmCampaign3.value.trim()
        })
      : (p.href || "#");

    html = html
      .replaceAll(`{{href${n}}}`, finalHref || "#")
      .replaceAll(`{{src${n}}}`, p.src || "https://via.placeholder.com/512x604.png?text=Image")
      .replaceAll(`{{alt${n}}}`, escapeHtml(p.alt || ""));
  });

  return html.trim();
}

function update3col() {
  utmFields3.style.display = utmToggle3.checked ? "grid" : "none";
  const html = buildHtml3col();
  output3colEl.value = html;
  preview3colEl.innerHTML = html;
}

copyBtn3col.addEventListener("click", async () => {
  try {
    await navigator.clipboard.writeText(output3colEl.value);
    copyStatus3col.textContent = "Afritað! Límdu í SendGrid Code Block.";
    setTimeout(() => copyStatus3col.textContent = "", 1500);
  } catch {
    copyStatus3col.textContent = "Gat ekki afritað — afritaðu handvirkt.";
  }
});

resetBtn3col.addEventListener("click", () => {
  products3col.forEach(p => { p.href=""; p.src=""; p.alt=""; });
  renderInputs3col();
  update3col();
});

[utmToggle3, utmSource3, utmMedium3, utmCampaign3].forEach(el =>
  el.addEventListener("input", update3col)
);


  /* ===================== TAB: 2-column recipes ===================== */
const NUM_RECIPES = 2;

const recipes2 = Array.from({ length: NUM_RECIPES }, () => ({
  href: "",
  src: ""
}));

const inputs2recipesEl = document.getElementById("inputs2recipes");
const output2recipesEl = document.getElementById("output2recipes");
const preview2recipesEl = document.getElementById("preview2recipes");
const copyBtn2recipes = document.getElementById("copyBtn2recipes");
const resetBtn2recipes = document.getElementById("resetBtn2recipes");
const copyStatus2recipes = document.getElementById("copyStatus2recipes");

function renderInputs2recipes() {
  inputs2recipesEl.innerHTML = "";

  recipes2.forEach((p, idx) => {
    const card = document.createElement("div");
    card.innerHTML = `
      <div style="border:1px solid #eee;border-radius:10px;padding:10px;">
        <strong>Dálkur ${idx + 1}</strong>

        <label>Vörutengill (href)</label>
        <input data-k="href" data-i="${idx}" placeholder="https://kronan.is/uppskriftir/..." value="${p.href}"/>

        <label>Myndatengill (src)</label>
        <input data-k="src" data-i="${idx}" placeholder="http://cdn.mcauto-images...png" value="${p.src}"/>
      </div>
    `;
    inputs2recipesEl.appendChild(card);
  });

  inputs2recipesEl.querySelectorAll("input").forEach(inp => {
    inp.addEventListener("input", e => {
      const i = Number(e.target.dataset.i);
      const k = e.target.dataset.k;
      recipes2[i][k] = e.target.value.trim();
      update2recipes();
    });
  });
}

// YOUR TEMPLATE KEPT VERBATIM (only href/src placeholders)
const TEMPLATE_2RECIPES = String.raw`<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
  /* Mobile-only overrides (Gmail/Android friendly) */
  @media only screen and (max-width:640px),
         only screen and (max-device-width:640px) {

    .responsive-table, [class~="responsive-table"] {
      width: 100% !important;
      margin: 0 auto !important;
      padding: 0 !important; /* avoid double padding from wrapper */
    }

    .column, [class~="column"] {
      display: block !important;
      width: 100% !important;
      max-width: 100% !important;
      text-align: center !important;
      margin: 0 auto 10px !important;
      padding: 0 !important; /* prevent compounding widths */
    }

    /* Reliable 28px side gutters per card */
    .mobile-pad, [class~="mobile-pad"] {
      padding-left: 12px !important;
      padding-right: 12px !important;
    }

    .column img, [class~="column"] img {
      width: 100% !important;
      height: auto !important;
      max-width: 100% !important;
      display: block !important;
      margin: 0 auto !important;
    }
  }
  </style>
</head>

<body>
  <table class="responsive-table" width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;">
    <tr>
      <!-- First Column -->
      <td class="column" width="48%" valign="top" style="padding:12px; font-size:14px; line-height:20px;">
        <table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0">
          <tr>
            <!-- Mobile adds 28px L/R here -->
            <td class="mobile-pad" style="padding:0;">
              <a href="{{href1}}">
                <img border="0" style="display:block; max-width:100%; width:100%; height:auto;" width="300" alt="Maiskokur" src="{{src1}}">
              </a>
            </td>
          </tr>
        </table>
      

      <!-- Second Column -->
      </td><td class="column" width="48%" valign="top" style="padding:12px; font-size:14px; line-height:20px;">
        <table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0">
          <tr>
            <td class="mobile-pad" style="padding:0;">
              <a href="{{href2}}">
                <img border="0" style="display:block; max-width:100%; width:100%; height:auto;" width="300" alt="Maískokur" src="{{src2}}">
              </a>
            </td>
          </tr>
        </table>
      </td>
    
  </tr></table>
</body>`;

function buildHtml2recipes() {
  let html = TEMPLATE_2RECIPES;

  recipes2.forEach((p, idx) => {
    const n = idx + 1;
    html = html
      .replaceAll(`{{href${n}}}`, p.href || "#")
      .replaceAll(`{{src${n}}}`, p.src || "https://via.placeholder.com/512x517.png?text=Recipe");
  });

  return html.trim();
}

function update2recipes() {
  const html = buildHtml2recipes();
  output2recipesEl.value = html;
  preview2recipesEl.innerHTML = html;
}

copyBtn2recipes.addEventListener("click", async () => {
  try {
    await navigator.clipboard.writeText(output2recipesEl.value);
    copyStatus2recipes.textContent = "Afritað! Límdu í SendGrid Code Block.";
    setTimeout(() => copyStatus2recipes.textContent = "", 1500);
  } catch {
    copyStatus2recipes.textContent = "Gat ekki afritað — afritaðu handvirkt.";
  }
});

resetBtn2recipes.addEventListener("click", () => {
  recipes2.forEach(p => { p.href = ""; p.src = ""; });
  renderInputs2recipes();
  update2recipes();
});

/* Init */
renderInputs2recipes();
update2recipes();

/* ===================== TAB 2: Card builder ===================== */
/* EDIT THIS if your Worker URL changes */
const PROXY_URL =
  "https://workers-playground-patient-frog-cbe4.thorvaldura.workers.dev/?url=";
const IMG_PROXY_URL =
  "https://workers-playground-patient-frog-cbe4.thorvaldura.workers.dev/img?url=";


const productUrlCardEl = document.getElementById("productUrlCard");
const createBtnCard = document.getElementById("createBtnCard");
const copyBtnCard = document.getElementById("copyBtnCard");
const downloadPngBtnCard = document.getElementById("downloadPngBtnCard");
const previewCardEl = document.getElementById("previewCard");
const outputCardEl = document.getElementById("outputCard");
const statusCardEl = document.getElementById("statusCard");

/* NEW: editable overrides */
const manualNameEl = document.getElementById("manualName");
const manualPriceEl = document.getElementById("manualPrice");
const updateBtnCard = document.getElementById("updateBtnCard");
let lastProductData = null;

function getMergedCardData() {
  if (!lastProductData) return null;

  const nameOverride = manualNameEl.value.trim();
  const priceOverride = manualPriceEl.value.trim();

  const merged = { ...lastProductData };

  if (nameOverride) merged.name = nameOverride;

  if (priceOverride) {
    // keep consistent; renderer uses priceNew for discount if present
    merged.price = priceOverride;
    if (merged.priceNew) merged.priceNew = priceOverride;
  }

  return merged;
}

function renderCardFromState() {
  const merged = getMergedCardData();
  if (!merged) return;

  const cardHtml = buildCardHtml(merged);
  outputCardEl.value = cardHtml;
  previewCardEl.innerHTML = cardHtml;
}

createBtnCard.addEventListener("click", async () => {
  const url = productUrlCardEl.value.trim();
  if (!url) return setStatusCard("Settu inn slóð.", true);

  setStatusCard("Sæki vöru…", false);
  previewCardEl.innerHTML = "";
  outputCardEl.value = "";

  try {
    const data = await fetch(PROXY_URL + encodeURIComponent(url)).then(r => r.json());

    if (!data?.name || !data?.price || !data?.image) {
      throw new Error("Missing fields in JSON");
    }

    lastProductData = data;

    // Prefill editable fields
    manualNameEl.value = data.name || "";
    manualPriceEl.value = (data.priceNew || data.price) || "";

    renderCardFromState();

    setStatusCard("Tilbúið ✅", false);
  } catch (e) {
    console.error(e);
    setStatusCard("Tókst ekki að sækja vöru. Athugaðu slóð eða proxy.", true);
  }
});

updateBtnCard.addEventListener("click", () => {
  if (!lastProductData) return setStatusCard("Búðu fyrst til kort með slóð.", true);
  renderCardFromState();
  setStatusCard("Uppfært ✅", false);
  setTimeout(()=>setStatusCard("",false), 1200);
});

/* Optional: live update as you type */
[manualNameEl, manualPriceEl].forEach(el => {
  el.addEventListener("input", () => {
    if (!lastProductData) return;
    renderCardFromState();
  });
});

copyBtnCard.addEventListener("click", async () => {
  if (!outputCardEl.value) return;
  try {
    await navigator.clipboard.writeText(outputCardEl.value);
    setStatusCard("Afritað HTML ✅", false);
    setTimeout(()=>setStatusCard("",false), 1200);
  } catch {
    setStatusCard("Gat ekki afritað — afritaðu handvirkt.", true);
  }
});

downloadPngBtnCard.addEventListener("click", async () => {
  const node = previewCardEl.firstElementChild; // the card div
  if (!node) {
    setStatusCard("Engin kort til að sækja. Búðu fyrst til kort.", true);
    return;
  }

  setStatusCard("Bý til PNG…", false);

  try {
    if (document.fonts && document.fonts.ready) await document.fonts.ready;

    const canvas = await html2canvas(node, {
      backgroundColor: null,
      scale: 1,
      useCORS: true
    });

    // --- Rounded corner mask (8px) ---
    const w = canvas.width;
    const h = canvas.height;
    const r = 16; // corner radius

    const out = document.createElement("canvas");
    out.width = w;
    out.height = h;

    const ctx = out.getContext("2d");
    ctx.clearRect(0, 0, w, h);

    // Rounded-rect clip path
    ctx.beginPath();
    ctx.moveTo(r, 0);
    ctx.arcTo(w, 0, w, h, r);
    ctx.arcTo(w, h, 0, h, r);
    ctx.arcTo(0, h, 0, 0, r);
    ctx.arcTo(0, 0, w, 0, r);
    ctx.closePath();
    ctx.clip();

    ctx.drawImage(canvas, 0, 0);

    const dataUrl = out.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = dataUrl;
    a.download = `product-card-${Date.now()}.png`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    setStatusCard("PNG sótt ✅", false);
    setTimeout(() => setStatusCard("", false), 1200);
  } catch (e) {
    console.error(e);
    setStatusCard("Tókst ekki að búa til PNG.", true);
  }
});


function buildCardHtml(p) {
  // Card size (must match .card-shell)
  const CARD_W = 420;
  const CARD_H = 479;

  // Layout tuned for 420×479
  const PADDING = 40;
  const GAP_AFTER_IMAGE = 12;
  const IMAGE_AREA_HEIGHT = 255;
  const PRICE_FONT_SIZE = 22;                 // matches your current price font-size
  const INFO_ICON_SIZE = Math.round(PRICE_FONT_SIZE * 1.5); // ~1.5x


  const imgSrc = IMG_PROXY_URL + encodeURIComponent(p.image);
  const hasDiscount = !!(p.priceOld && p.priceNew);
  const newPriceText = hasDiscount ? p.priceNew : p.price;
  
  const oldPriceHtml = hasDiscount
    ? `<span style="
          font-family:'Basic Sans', Arial, sans-serif;
          font-size:14px;
          font-weight:600;
          color:#787878;
          text-decoration:line-through;
          margin-right:10px;
        ">${escapeHtml(p.priceOld)}</span>`
    : "";

  return `
<div style="
  width:${CARD_W}px;
  height:${CARD_H}px;
  border:1px solid #D9D9D9;
  border-radius:8px;
  overflow:hidden;
  background:#ffffff;
  box-sizing:border-box;
  font-family:'Basic Sans', Arial, sans-serif;
  padding:${PADDING}px;
  display:flex;
  flex-direction:column;
">

<!-- Image area -->
<div style="
  height:${IMAGE_AREA_HEIGHT}px;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  margin-bottom:${GAP_AFTER_IMAGE}px;
  margin-top:22px;
">
  <img src="${imgSrc}" alt="${escapeHtml(p.name)}"
       style="
         max-width:100%;
         max-height:100%;
         object-fit:contain;
         display:block;
         border:0;
       " />
</div>

  <!-- Text area pinned to bottom -->
  <div style="margin-top:auto;">
    <div style="
      font-family:'Basic Sans', Arial, sans-serif;
      font-size:28px;
      font-weight:700;
      line-height:1.2;
      color:#111111;
      margin:0 0 22px 0;
      word-break:break-word;
    ">
      ${escapeHtml(p.name)}
    </div>

<div style="
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:12px;
  margin-bottom:22px;
">
  <!-- Price (left) -->
  <div style="line-height:1.2;">
    ${oldPriceHtml}
    <span style="
      font-family:'Basic Sans', Arial, sans-serif;
      font-size:${PRICE_FONT_SIZE}px;
      font-weight:500;
      color:#787878;
    ">
      ${escapeHtml(newPriceText)}
    </span>
  </div>

  <!-- Info icon (right) -->
  <div style="
    width:${INFO_ICON_SIZE}px;
    height:${INFO_ICON_SIZE}px;
    flex:0 0 ${INFO_ICON_SIZE}px;
    display:flex;
    align-items:center;
    justify-content:center;
  " aria-label="Info">
    <!-- inline SVG so it works in PNG export + copied HTML -->

<svg width="42" height="42" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_10192_6996)">
<g clip-path="url(#clip1_10192_6996)">
<path d="M1.25488 8.98862C1.55273 12.765 4.70145 15.7328 8.55225 15.7328C9.88194 15.7328 11.1159 15.3712 12.1903 14.7542C11.7116 11.031 8.54161 8.15889 4.68018 8.15889C3.44622 8.15889 2.28673 8.45674 1.25488 8.98862Z" fill="#03FFFF"/>
<path d="M8.54143 16.2755C4.21195 16.2755 0.690918 12.7438 0.690918 8.4143C0.690918 4.08481 4.21195 0.563782 8.54143 0.563782C12.8709 0.563782 16.392 4.08481 16.392 8.4143C16.392 12.7438 12.8709 16.2648 8.54143 16.2648V16.2755ZM8.54143 1.62754C4.79701 1.62754 1.75467 4.66988 1.75467 8.4143C1.75467 12.1587 4.79701 15.2011 8.54143 15.2011C12.2859 15.2011 15.3282 12.1587 15.3282 8.4143C15.3282 4.66988 12.2859 1.62754 8.54143 1.62754Z" fill="black"/>
<path d="M8.5414 12.7332C8.24355 12.7332 8.00952 12.4991 8.00952 12.2013V8.03136C8.00952 7.73351 8.24355 7.49948 8.5414 7.49948C8.83925 7.49948 9.07328 7.73351 9.07328 8.03136V12.2013C9.07328 12.4991 8.83925 12.7332 8.5414 12.7332Z" fill="black"/>
<path d="M8.54136 5.80811C8.86449 5.80811 9.12643 5.54617 9.12643 5.22304C9.12643 4.89992 8.86449 4.63798 8.54136 4.63798C8.21824 4.63798 7.9563 4.89992 7.9563 5.22304C7.9563 5.54617 8.21824 5.80811 8.54136 5.80811Z" fill="black"/>
</g>
</g>
<defs>
<clipPath id="clip0_10192_6996">
<rect width="17.0201" height="17.0201" fill="white"/>
</clipPath>
<clipPath id="clip1_10192_6996">
<rect width="15.7117" height="15.7117" fill="white" transform="translate(0.690918 0.563782)"/>
</clipPath>
</defs>
</svg>

  </div>
</div>

`.trim();
}

function setStatusCard(msg, isError){
  statusCardEl.textContent = msg;
  statusCardEl.style.color = isError ? "#b00020" : "#333";
}

/* ===================== Helpers ===================== */
function escapeHtml(str) {
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function addUTM(url, utmObj) {
  if (!url) return "#";
  try {
    const u = new URL(url);
    Object.entries(utmObj).forEach(([k, v]) => {
      if (!v) return;
      if (!u.searchParams.has(k)) u.searchParams.set(k, v);
    });
    return u.toString();
  } catch {
    return url;
  }
}

/* Init */
renderInputs3col();
update3col();
</script>
</body>
</html>














